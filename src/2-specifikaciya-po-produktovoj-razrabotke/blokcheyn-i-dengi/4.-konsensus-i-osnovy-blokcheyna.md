# 4. Консенсус и основы блокчейна

Лекция [№4](https://api.vc.ru/v2.8/redirect?to=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Dj1XdgNbXSY0&postId=1061418) из курса MIT «Блокчейн и деньги» посвящена технологии Биткоина. В ней Гари Генслер рассказывает о том, как устроен майнинг, как подтверждаются блоки и какими бывают системы консенсуса.

![Консенсус и основы блокчейна](https://leonardo.osnova.io/a371de3f-e0a8-5ed3-ac6b-0ac55020091e/-/preview/592x/)

## План лекции

1. [Обзор технологии блокчейна](https://vc.ru/crypto/1061418-konsensus-i-osnovy-blokcheina#overview)
2. [Консенсус через Proof of Work](https://vc.ru/crypto/1061418-konsensus-i-osnovy-blokcheina#pow)
3. [Майнинг биткоинов](https://vc.ru/crypto/1061418-konsensus-i-osnovy-blokcheina#miming)
4. [Нативные валюты](https://vc.ru/crypto/1061418-konsensus-i-osnovy-blokcheina#natives)
5. [Сеть](https://vc.ru/crypto/1061418-konsensus-i-osnovy-blokcheina#web)
6. [Альтернативные протоколы консенсуса](https://vc.ru/crypto/1061418-konsensus-i-osnovy-blokcheina#alt)

## Вопросы лекции

- В чем заключается «Задача византийских генералов»? Как ее решают proof-of-work и майнинг в Биткойне? И в целом технология блокчейн?
- Какие ещё существуют протоколы консенсуса? Каковы компромиссы альтернативных алгоритмов консенсуса, proof-of-work, proof-of-stake и т.д.?
- Как Биткоин регистрирует транзакции?

## Материалы для чтения

1. ‘[21st Geneva Report on the World Economy - The Impact of Blockchain Technology on Finance: Catalyst for Change’](https://api.vc.ru/v2.8/redirect?to=https%3A%2F%2Fcepr.org%2Fpublications%2Fbooks-and-reports%2Fgeneva-21-impact-blockchain-technology-finance-catalyst-change&postId=1061418) Chapter 1 (pages 1 – 7); Casey, Crane, Gensler, Johnson, and Narula (July 2018)

2. ‘[Blockchain Technology Overview’ (PDF)](https://api.vc.ru/v2.8/redirect?to=https%3A%2F%2Fcsrc.nist.gov%2FCSRC%2Fmedia%2FPublications%2Fnistir%2F8202%2Fdraft%2Fdocuments%2Fnistir8202-draft.pdf&postId=1061418) National Institute of Standards and Technology (January 2018) (pages 9 – 23, sections 1 & 2)

3. ‘[The Byzantine Generals Problem](https://api.vc.ru/v2.8/redirect?to=https%3A%2F%2Fdl.acm.org%2Fcitation.cfm%3Fid%3D357176&postId=1061418)’ Lamport, Shostak, & Pease; ACM Transactions on Programming Languages and Systems (TOPLAS), 4(3), (July 1982) (required 382-387)

4. ‘[A (Short) Guide to Blockchain Consensus Protocols](https://api.vc.ru/v2.8/redirect?to=https%3A%2F%2Fwww.coindesk.com%2Fshort-guide-blockchain-consensus-protocols&postId=1061418)’ CoinDesk (March 4, 2017)

Опционально:

5. For those wishing for a technical dive into Bitcoin Scripting Language, one can review ‘[Script](https://api.vc.ru/v2.8/redirect?to=https%3A%2F%2Fgithub.com%2Fbitpay%2Fbitcore%23bitcore&postId=1061418)’ by Bitcore or [‘The Best Step-by-Step Bitcoin Script Guide](https://api.vc.ru/v2.8/redirect?to=https%3A%2F%2Fblockgeeks.com%2Fguides%2Fbest-bitcoin-script-guide%2F&postId=1061418)’ by Blockgeeks.

## Обзор технологии блокчейна

![Консенсус и основы блокчейна](https://leonardo.osnova.io/94af8d4f-7bbb-56a5-a04c-da4801abfcf6/-/preview/592x/)

Тот факт, что блоки в блокченйне можно только добавлять, но нельзя удалять, делает его _неизменным_. Иначе говоря, мы не можем поменять его содержимое.

Блокчейн создает базу данных благодаря хеш-функциям и цифровым подписям. Так же в технологию блокчейна входит консенсус.

**Технологические особенности**

- Криптография и временные отметки
- Децентрализованный протокол консенсуса, сеть, нативная валюта
- Скрипт транзакций

_Криптография_ — это коммуникация в присутствии врагов, а так же способ передачи информации.

_Хеш-функции_ — это функции, выполняющие одностороннее сжатие данных.

_Записи, которые невозможно удалить (Timestamped Append-only Log)_ — буквально, вы можете только увеличить запись и добавить в нее строки, но не можете удалять ее элементы.

_Дерево Меркла (дерево хешей)_ — это концепция работы с данными, бинарное дерево хешей.

![Консенсус и основы блокчейна](https://leonardo.osnova.io/d9029b69-27a7-52f4-bc4e-e723ff5f5a51/-/preview/592x/)

_Цифровая подпись_ — инструмент для подтверждения подписи чего-то (например, транзакции) при помощи своего приватного ключа и проверки другим человеком вашей подписи с помощью публичного ключа. Она защищает от подделок и попыток выдачи себя за другое лицо.

Цифровые подписи бывают как с хешем (блокчейн), так и без хеша.

![Цифровая подпись с хешем](https://leonardo.osnova.io/344127cb-11d8-5dce-8dfc-0e3efa9c632b/-/preview/592x/)

Цифровая подпись с хешем

Что, по сути, делает любой блокчейн: берет транзакцию и хеширует её.

_Биткоин адрес_ — способ, благодаря которому можно идентифицировать биткоин, захешированный публичный ключ. Биткоин-адрес определяется Публичным ключом, но не равен ему.

![Консенсус и основы блокчейна](https://leonardo.osnova.io/6c9aa397-fb00-52a2-a2d5-5c5ad5c1560f/-/preview/592x/)

**Децентрализованные сети**

«Задача византийских генералов» — это общая математическая задача о том, как координировать участников группы, если часть её участников действует не в интересах всей группы. Такая же задача существует в области компьютеров: как децентрализованная сеть будет приходить к каким-либо соглашениям в отсутствие централизатора? В данном случае безопасность сети будет основываться на Протоколе Консенсуса и нативной валюте (ключевое изобретение Сатоши Накамото — объединение этих двух моментов, но многие иные моменты являются заслугами других людей).

## Консенсус через Proof of Work (Доказательство работы)

Так, Адам Бэк в 1997 году предложил способ борьбы со спамом в электронной почте, а так же другими проблемами DoS-атак, на основе вычислительных мощностей и использования хеш-функций.

Концепция Proof of Work была предложена за 11 лет до изобретения биткоина. Вопрос был в том, как эффективно использовать технологию хеширования в цепочке данных.

На графике функция SHA256 используется для хеширования шапки блока. Она хеширует: предыдущий хеш блока, хеш транзакции, временную отметку и одноразовое число Nonce. По сути, Сатоши Накамото использовал наработки Адама Бека для электронной почты.

![Консенсус и основы блокчейна](https://leonardo.osnova.io/327a66ee-9cec-55b6-8860-11f40986dc05/-/preview/592x/)

_Консенсус в блокчейне_ — это та цепочка, на которой майнеры больше всего наращивают информацию, самая длинная цепочка. Самая долгая ответвленная цепочка длилась всего 2-3 блока.

> Что было бы, если бы Китай попробовал бы ответвиться или отсоединиться?
> 
> вопрос студентки

Давайте представим, что Китай — это фиолетовые блоки:

![Консенсус и основы блокчейна](https://leonardo.osnova.io/9e14abb6-3e34-55c0-906a-b3ac5361cfde/-/preview/592x/)

Предполагается, что в таком случае произойдет какая-то внешняя коммуникация — ТВ или просто межличностное общение. В таком случае китайские майнеры в какой-то момент поймут, что они не находятся в основной цепочке биткоинов, в которой находится основное число майнеров, и перестанут тратить электроэнергию на майнинг в таких условиях. Потому что они понимают, что в таком случае все их затраты окажутся ничего не стоящими.

Однако все же есть малая вероятность, что в итоге мы получим 2 блокчейна: китайский и общемировой. Так как, например, если бы сложилась ситуация, что фиолетовые блоки продолжали бы формироваться в течение тысяч и тысяч блоков, и был бы социальный консенсус, который держал бы при жизни обе цепи, то у нас сформировалось бы уже 2 валюты, как это произошло с биткоином и биткоин-кэшем (Bitcoin Cash BCH).

> Получают ли майнеры биткоин в устаревших блоках?
> 
> вопрос студента

В фиолетовых блоках будет коинбейс-транзакция, которая вознаграждает майнеров. Но эта транзакция по итогу ничего не будет стоить, потому что не находится на основной цепочке блоков и ее нельзя будет использовать позже.

Так же в коде биткоина есть такая строчка: «вознаграждение майнеров нельзя потратить в течение 100 блоков после их получения» для большей безопасности.

## Майнинг биткоинов

**Фактор сложности майнинга**

Proof of Work в случае с биткоином имеет фактор сложности, который определяется лидирующими нулями в его хеше. Сатоши Накамото предложил производить новый блок каждые 10 минут: для этого нужно определить, сколько лидирующих нулей вообще будет присутствовать. Эта сложность саморегулируется раз в 2 недели. Текущий уровень сложности (на момент выхода лекции) таков, что необходимо 18 лидирующих нулей в хеш-функции.

Последний блок, выписанный Генслером перед лекцией (№541974):

Block 541974 (9/18/18)- 18 leading zeros 0000000000000000001104a863046dfbad1a2941128815669623ff93c2a3945f

У самого первого блока, который был добыт в сети Биткоин в апреле 2008 года, было 10 лидирующих нулей.

Genesis Block (1/3/09) – 10 leading zeros, though only required 8 000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f

Как увеличивается сложность добычи биткоина:

![Консенсус и основы блокчейна](https://leonardo.osnova.io/f5a36ecb-670b-5387-8a5a-7b43029d1a15/-/preview/592x/)

Это происходит из-за того, что у нас появляется все больше и больше компьютеров, которые пытаются всё это захешировать.

**Эволюция биткоин-майнинга**

> Майнинговая мощь биткоина увеличивается не из-за того, что линейно увеличивается количество пользователей, которые майнят, но потому что оборудование становится намного лучше.

Всё началось с центральных процессоров. На процессоре можно сделать от 2 до 20 млн хешей в секунду, если процессор правильно настроен. Однако уже в 2010 году было вычислено, что есть кое-что быстрее процессоров — графический процессор, видеокарта. Связывая между собой большое количество видеокарт можно было добиться мощности от 20 до 300 млн хешей в секунду.

Позднее, в 2013, появились Специализированные интегрированные схемы (ASICs) — аппараты, заточенные на то, чтобы совершать множество хешей и больше ничего. В 2019 самый дорогой ASIC стоил 3-4 тысячи долларов за штуку и мог выдавать 16 террахешей в секунду. На современных майнинговых производствах стоят тысячи ASIC-ов.

![Консенсус и основы блокчейна](https://leonardo.osnova.io/3a690a06-7bdf-59ae-aebd-e9869d5b84df/-/preview/592x/)

Вся экономика майнинга разворачивается вокруг нескольких майнинговых пулов. Стандартная комиссия у майнинговых операторов составляет 1–3%: за это оператор майнингового пула предоставляет своим клиентам-майнерам ряд различных услуг.

## Нативные валюты

Нативные валюты помогают запустить процесс системы вознаграждения блокчейна. Валюта используется для вознаграждения, а так же для перевода денег. Валюты встроены в большинство блокчейнов, но не во все (т.н. «денежно-кредитная политика» ограничивает количество монет).

**Биткоин**

Он создается в coinbase-транзакции в каждом блоке. Изначально добыча блока вознаграждалась 50 биткоинами за блок. На момент выхода лекции вознаграждение равнялось 12.5 биткоинам за блок.

**Эфир (Ethereum)**

На момент выхода лекции майнился в количестве 3 ETH за блок. Транзакции оплачиваются, как правило, в GAS — единица измерения в Эфире (как Сатоши в биткоине).

## Сеть

**Полная нода** (Full Nodes) — сетевой узел, или же компьютер, который хранит в себе весь блокчейн (всю историю) и может подтверждать транзакции.

**Урезанная нода** (Pruning Nodes) — «обрезает» старые транзакции, которые уже были валидированы.

**Облегченная нода** (Lightweight Nodes) — нода, которая есть у каждого владельца биткоин-кошелька. Сохраняет в себе лишь фрагменты блоков вместо хранения полного блокчейна. Потребляет намного меньше памяти, но зависит от Полной ноды, так как сама не может проводить верификацию.

**Майнеры** (Miners) – выполняют проверку работоспособности и создают новые блоки. Большинство из них не владеют Полной нодой.

**Кошельки** (Wallets) – хранят, видят, отправляют и получают транзакции и генерируют пары ключей.

**Мемпул** (Mempool) — пул неподтвержденных (но валидированных) транзакций.

## Альтернативные протоколы консенсуса

Обычно рандомизируют или делегируют выборку нод для проверки следующего блока (используют различные математические уравнения). В некоторых формах консенсуса может быть двойная проверка.

Виды систем консенсусов:

Proof of Stake — основывается на том, сколько нативных валют вы вложили в систему.

Proof of Activity — гибрид PoW и PoS.

Proof of Burn — нужно сжигать свои монеты.

Proof of Capacity (Storage or Space) — нужно предоставить хранилище для информации.

Так же может быть многоуровневая система. Но пока что большинство блокчейнов используют PoW.

## Вопросы к следующей лекции

1. Как Биткоин регистрирует транзакции? Что такое выходные данные неизрасходованной транзакции (UTXO)? Что такое скриптовый код, встроенный в каждую транзакцию Биткойна, и насколько это гибкий язык программирования?  
2. Поскольку многие конструктивные особенности – криптография с открытым ключом, хэш-функции, журналы с отметками времени append only, цифровые наличные и PoW — появились до Биткоина, в чем же заключалось новшество Сантоши Накамото?  
3. Кто такой Сатоши Накамото? (Шутка)

## Литература

— ‘Bitcoin’s Academic Pedigree’ Narayanan and Clark

— ‘Making Sense of Cryptoeconomics’ CoinDesk