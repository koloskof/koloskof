# SQL: Advanced

---

### Операции с текстом

**`CONCAT` или `||`** 

Используется для конкатенации, то есть объединения строк:

Пример:

```sql
SELECT 'A' || '-' || 'B' AS result
```

Результат:

```sql
A-B
```

Пример:

```sql
SELECT
CONCAT(first_name, ' ', last_name) 
FROM users
```

Результат:

```sql
Anna Morozova

```

**`LENGTH`**

Используется для определения длины строки:

Пример:

```sql
SELECT LENGTH('SQL')
```

Результат:

```sql
3
```

**`SUBSTRING`**

Используется для поиска по порядку элементов в строке:

Пример:

```sql
SELECT SUBSTRING('ProductStar', 1, 8)
```

Результат:

```sql
ProductS
```

**`REGEXP`**

Используется для поиска по группе символов и знаков (шаблону):

Структура запроса:

```sql
SELECT REGEXP_MATCHES
('SQL #Course #Product_Star', 
'#([A-Za-z0-9_]+)',
'g'
```

Пример:

```sql
Course
Product_Star

```

### Оконные функции

- Используются для подсчета некоторой **функции** по какому-либо **окну**, то есть группе строк
- **Функции** бывают ****
    - агрегатные: SUM(), MIN(), MAX(), AVG(), COUNT()
    - ранжирующие: ROW_NUMBER(), RANK(), DENSE_RANK() и т.д.
    - смещающие: LAG(), LEAD(), FIRST_VALUE(), LAST_VALUE() и т.д
- **Окно** из строк можно отсортировать, сгруппировать или выбрать без какого-либо условия

### Ускорение и оптимизация запросов

- Уменьшение размера таблицы, упрощение джоинов и грамотное использование подзапросы облегчает и ускоряет запросы
- Также для ускорения доступа к данным и самих запросов можно использовать **индексы**
- **`EXPLAIN`** выводит информацию о том, что и в каком порядке делает ядро при каждом конкретном запросе

### Представления и общие табличные выражения

**`VIEW`**

Объект базы данных, являющийся результатом выполнения определенного запроса SELECT:

Структура запроса:

```sql
CREATE VIEW view_name AS
SELECT column1, column2, ...
FROM table_name
WHERE condition
```

Пример:

```sql
CREATE VIEW de_users AS
SELECT id, first_name, last_name
FROM users
WHERE country = 'DE'
```

**`WITH`**

Создает временные таблицы, существующие только для одного запроса:

Структура запроса:

```sql
WITH w AS (sql_query)

SELECT * FROM w ...
```

Пример:

```sql
WITH w AS (SELECT * FROM big_table)

SELECT * FROM w WHERE key = 123
```